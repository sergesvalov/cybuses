<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Paphos Bus Board</title>
    <style>
        :root { --p: #007bff; --bg: #f2f4f7; --card: #fff; --green: #28a745; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; -webkit-tap-highlight-color: transparent; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .refresh-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
        .spinning { animation: spin 1s linear infinite; opacity: 0.5; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .scroll-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 12px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }

        .d-btn { padding: 10px 14px; background: #fff; border: 1px solid #ddd; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; user-select: none; }
        .d-btn.active { background: var(--p); color: #fff; border-color: var(--p); box-shadow: 0 2px 5px rgba(0,123,255,0.3); }

        .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .c-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .c-title { font-weight: 700; font-size: 1.1rem; }
        .c-desc { font-size: 0.85rem; color: #666; margin-top: 2px; }
        
        .times-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; }
        
        .t-btn { 
            background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 8px 0; 
            text-align: center; font-size: 14px; font-weight: 500; color: #333; cursor: pointer; 
            position: relative; transition: 0.2s;
        }
        .t-btn sup { color: #e74c3c; font-weight: bold; }
        .t-btn.has-note { background: #fff5f5; border-color: #ffcccc; }
        
        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ü–û–î–°–í–ï–¢–ö–ò --- */
        .t-btn.past { opacity: 0.4; background: #eee; color: #999; }
        .t-btn.next { 
            background: var(--green); color: #fff; border-color: var(--green); 
            font-weight: 700; transform: scale(1.05); z-index: 2; 
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
        }
        /* --------------------------- */

        .modal { display: none; position: fixed; top: 0; left: 0; w: 100%; h: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .m-content { background: #fff; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .m-time { font-size: 2rem; font-weight: 800; color: var(--p); margin-bottom: 10px; }
        .m-note { font-size: 1rem; color: #444; margin-bottom: 20px; line-height: 1.5; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .m-close { background: var(--p); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; font-size: 1rem; width: 100%; cursor: pointer; }

        .loader { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0">üá®üáæ Bus Board</h2>
        <button class="refresh-btn" id="r-btn" onclick="refresh()">‚Üª</button>
    </div>

    <div class="scroll-row">
        <button class="d-btn active" onclick="setF('p','all',this)">All</button>
        <button class="d-btn" onclick="setF('p','intercity',this)">Intercity</button>
        <button class="d-btn" onclick="setF('p','osypa',this)">City</button>
        <button class="d-btn" onclick="setF('p','shuttle',this)">Airport</button>
    </div>

    <div id="app"></div>

    <div id="modal" class="modal" onclick="closeM(event)">
        <div class="m-content" onclick="event.stopPropagation()">
            <div id="m-t" class="m-time"></div>
            <div id="m-n" class="m-note"></div>
            <button class="m-close" onclick="closeM()">OK</button>
        </div>
    </div>

    <script>
        let DATA = [];
        let STATE = { p: 'all' };

        async function load() {
            document.getElementById('app').innerHTML = '<div class="loader">Loading schedules...</div>';
            try {
                const res = await fetch('/api/data');
                DATA = await res.json();
                render();
            } catch(e) { document.getElementById('app').innerHTML = '<div class="loader">Error loading data</div>'; }
        }

        function render() {
            const c = document.getElementById('app');
            c.innerHTML = '';
            const fData = DATA.filter(d => STATE.p === 'all' || d.prov === STATE.p);
            
            if(!fData.length) { c.innerHTML = '<div class="loader">No routes found</div>'; return; }

            fData.forEach(r => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const timesHtml = r.times.map(t => {
                    // –°–°–´–õ–ö–ò
                    if (t.t === 'LINK') {
                        const url = t.url || r.url; 
                        return `<a href="${url}" target="_blank" class="t-btn" 
                                   style="grid-column: 1 / -1; text-decoration: none; color: #fff; background-color: var(--p); border-color: var(--p);">
                                   ${t.f}
                                </a>`;
                    }

                    // –û–ë–´–ß–ù–û–ï –í–†–ï–ú–Ø
                    const stars = t.n || '';
                    const noteTxt = t.note_txt ? t.note_txt.replace(/"/g, '&quot;') : ''; 
                    const hasNoteClass = noteTxt ? 'has-note' : '';
                    const action = noteTxt ? `onclick="showN('${t.t}', '${stars}', '${noteTxt}')"` : '';
                        
                    return `<div class="t-btn ${hasNoteClass}" ${action}>
                                ${t.t}<sup>${stars}</sup>
                            </div>`;
                }).join('');

                card.innerHTML = `
                    <div class="c-head">
                        <div>
                            <div class="c-title">${r.name}</div>
                            <div class="c-desc">${r.desc}</div>
                        </div>
                        <a href="${r.url}" target="_blank" style="color:var(--p);text-decoration:none;font-size:1.2rem">‚Üó</a>
                    </div>
                    <div class="times-grid">${timesHtml}</div>
                `;
                c.appendChild(card);
            });

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
            highlightNext();
        }

        // --- –õ–û–ì–ò–ö–ê –ü–û–î–°–í–ï–¢–ö–ò ---
        function highlightNext() {
            const now = new Date();
            // –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω—É—Ç—ã –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–Ω—è
            const curMins = now.getHours() * 60 + now.getMinutes();

            document.querySelectorAll('.card').forEach(card => {
                let foundNext = false; // –§–ª–∞–≥, —á—Ç–æ –º—ã –Ω–∞—à–ª–∏ –ü–ï–†–í–´–ô –±—É–¥—É—â–∏–π —Ä–µ–π—Å
                
                card.querySelectorAll('.t-btn').forEach(btn => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
                    const txt = btn.innerText.replace(/[^\d:]/g, ''); 
                    if (!txt || txt.length < 4) return;

                    const [h, m] = txt.split(':').map(Number);
                    let busMins = h * 60 + m;

                    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –Ω–æ—á–∏: –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –≤–µ—á–µ—Ä (–ø–æ—Å–ª–µ 18:00), 
                    // –∞ –∞–≤—Ç–æ–±—É—Å –Ω–æ—á—å—é (00:00 - 03:00), —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –∞–≤—Ç–æ–±—É—Å "–∑–∞–≤—Ç—Ä–∞" (+24—á)
                    let effectiveBus = busMins;
                    let effectiveCur = curMins;
                    
                    if (effectiveBus < 180) effectiveBus += 1440; 
                    if (effectiveCur < 180) effectiveCur += 1440;

                    // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
                    btn.classList.remove('past', 'next');

                    if (effectiveBus < effectiveCur) {
                        btn.classList.add('past');
                    } else {
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –±—É–¥—É—â–∏–π —Ä–µ–π—Å - –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                        if (!foundNext) {
                            btn.classList.add('next');
                            foundNext = true;
                        }
                    }
                });
            });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É, –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—è –¥–∞–Ω–Ω—ã–µ
        setInterval(highlightNext, 60000);
        // ------------------------

        function setF(k, v, el) { 
            STATE[k] = v;
            el.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            render(); 
        }

        function showN(t, s, n) { 
            document.getElementById('m-t').innerText = t + s; 
            document.getElementById('m-n').innerText = n || 'No details available'; 
            document.getElementById('modal').style.display = 'flex'; 
        }

        function closeM(e) { document.getElementById('modal').style.display = 'none'; }

        async function refresh() {
            const btn = document.getElementById('r-btn'); btn.classList.add('spinning');
            await fetch('/api/refresh', {method:'POST'});
            const iv = setInterval(async () => {
                const s = await (await fetch('/api/status')).json();
                if(!s.updating) { clearInterval(iv); btn.classList.remove('spinning'); load(); }
            }, 2000);
        }
        load();
    </script>
</body>
</html>