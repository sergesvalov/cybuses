<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Paphos Bus Board</title>
    <style>
        :root { --p: #007bff; --bg: #f2f4f7; --card: #fff; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; -webkit-tap-highlight-color: transparent; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .refresh-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
        .spinning { animation: spin 1s linear infinite; opacity: 0.5; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .scroll-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 12px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }

        .d-btn { padding: 10px 14px; background: #fff; border: 1px solid #ddd; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; user-select: none; }
        .d-btn.active { background: var(--p); color: #fff; border-color: var(--p); box-shadow: 0 2px 5px rgba(0,123,255,0.3); }

        .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .c-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .c-title { font-weight: 700; font-size: 1.1rem; }
        .c-desc { font-size: 0.85rem; color: #666; margin-top: 2px; }
        
        .times-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; }
        .t-btn { 
            background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 8px 0; 
            text-align: center; font-size: 14px; font-weight: 500; color: #333; cursor: pointer; 
            position: relative; transition: 0.1s;
        }
        .t-btn sup { color: #e74c3c; font-weight: bold; }
        .t-btn.has-note { background: #fff5f5; border-color: #ffcccc; }
        .t-btn.has-note:active { transform: scale(0.95); }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; w: 100%; h: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .m-content { background: #fff; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .m-time { font-size: 2rem; font-weight: 800; color: var(--p); margin-bottom: 10px; }
        .m-note { font-size: 1rem; color: #444; margin-bottom: 20px; line-height: 1.5; background: #f8f9fa; padding: 10px; border-radius: 8px; }
        .m-close { background: var(--p); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; font-size: 1rem; width: 100%; cursor: pointer; }

        .loader { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0">üá®üáæ Bus Board</h2>
        <button class="refresh-btn" id="r-btn" onclick="refresh()">‚Üª</button>
    </div>

    <div class="scroll-row">
        <button class="d-btn active" onclick="setF('p','all',this)">All</button>
        <button class="d-btn" onclick="setF('p','intercity',this)">Intercity</button>
        <button class="d-btn" onclick="setF('p','osypa',this)">City</button>
        <button class="d-btn" onclick="setF('p','shuttle',this)">Airport</button>
    </div>

    <div id="app"></div>

    <div id="modal" class="modal" onclick="closeM(event)">
        <div class="m-content" onclick="event.stopPropagation()">
            <div id="m-t" class="m-time"></div>
            <div id="m-n" class="m-note"></div>
            <button class="m-close" onclick="closeM()">OK</button>
        </div>
    </div>

    <script>
        let DATA = [];
        let STATE = { p: 'all' };

        async function load() {
            document.getElementById('app').innerHTML = '<div class="loader">Loading schedules...</div>';
            try {
                const res = await fetch('/api/data');
                DATA = await res.json();
                render();
            } catch(e) { document.getElementById('app').innerHTML = '<div class="loader">Error loading data</div>'; }
        }

        function render() {
            const c = document.getElementById('app');
            c.innerHTML = '';
            const fData = DATA.filter(d => STATE.p === 'all' || d.prov === STATE.p);
            
            if(!fData.length) { c.innerHTML = '<div class="loader">No routes found</div>'; return; }

            fData.forEach(r => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const timesHtml = r.times.map(t => {
                    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–∫–∏-—Å—Å—ã–ª–∫–∏ (PDF/–°–∞–π—Ç)
                    if (t.t === 'LINK') {
                        const url = t.url || r.url; 
                        return `<a href="${url}" target="_blank" class="t-btn" 
                                   style="grid-column: 1 / -1; text-decoration: none; color: #fff; background-color: var(--p); border-color: var(--p);">
                                   ${t.f}
                                </a>`;
                    }

                    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ —Å–Ω–æ—Å–∫–∞–º–∏
                    const stars = t.n || '';
                    const noteTxt = t.note_txt ? t.note_txt.replace(/"/g, '&quot;') : ''; 
                    const hasNoteClass = noteTxt ? 'has-note' : '';
                    const action = noteTxt ? `onclick="showN('${t.t}', '${stars}', '${noteTxt}')"` : '';
                        
                    return `<div class="t-btn ${hasNoteClass}" ${action}>
                                ${t.t}<sup>${stars}</sup>
                            </div>`;
                }).join('');

                card.innerHTML = `
                    <div class="c-head">
                        <div>
                            <div class="c-title">${r.name}</div>
                            <div class="c-desc">${r.desc}</div>
                        </div>
                        <a href="${r.url}" target="_blank" style="color:var(--p);text-decoration:none;font-size:1.2rem">‚Üó</a>
                    </div>
                    <div class="times-grid">${timesHtml}</div>
                `;
                c.appendChild(card);
            });
        }

        function setF(k, v, el) { 
            STATE[k] = v;
            el.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            render(); 
        }

        function showN(t, s, n) { 
            document.getElementById('m-t').innerText = t + s; 
            document.getElementById('m-n').innerText = n || 'No details available'; 
            document.getElementById('modal').style.display = 'flex'; 
        }

        function closeM(e) { document.getElementById('modal').style.display = 'none'; }

        async function refresh() {
            const btn = document.getElementById('r-btn'); btn.classList.add('spinning');
            await fetch('/api/refresh', {method:'POST'});
            const iv = setInterval(async () => {
                const s = await (await fetch('/api/status')).json();
                if(!s.updating) { clearInterval(iv); btn.classList.remove('spinning'); load(); }
            }, 2000);
        }
        load();
    </script>
</body>
</html>