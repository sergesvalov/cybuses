<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Paphos Bus Board</title>
    <style>
        :root { --p: #007bff; --bg: #f2f4f7; --card: #fff; --green: #28a745; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; -webkit-tap-highlight-color: transparent; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .refresh-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
        .spinning { animation: spin 1s linear infinite; opacity: 0.5; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Rows for filters */
        .filter-group { margin-bottom: 15px; }
        .f-label { font-size: 12px; color: #888; margin-bottom: 6px; padding-left: 5px; text-transform: uppercase; font-weight: bold; }
        .scroll-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }

        .d-btn { padding: 8px 14px; background: #fff; border: 1px solid #ddd; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; user-select: none; transition: 0.2s; }
        .d-btn.active { background: var(--p); color: #fff; border-color: var(--p); box-shadow: 0 2px 5px rgba(0,123,255,0.3); }

        .card { background: var(--card); border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .c-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .c-title { font-weight: 700; font-size: 1.1rem; }
        .c-desc { font-size: 0.85rem; color: #666; margin-top: 2px; }
        .day-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #888; margin-left: 8px; vertical-align: middle; }
        
        .times-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 8px; }
        .t-btn { background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; padding: 8px 0; text-align: center; font-size: 14px; font-weight: 500; color: #333; cursor: pointer; position: relative; transition: 0.2s; }
        .t-btn.past { opacity: 0.4; background: #eee; color: #999; }
        .t-btn.next { background: var(--green); color: #fff; border-color: var(--green); font-weight: 700; transform: scale(1.05); z-index: 2; box-shadow: 0 4px 10px rgba(40,167,69,0.3); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .m-content { background: #fff; padding: 25px; border-radius: 16px; width: 80%; max-width: 320px; text-align: center; }
        .loader { text-align: center; padding: 40px; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0">üá®üáæ Bus Board</h2>
        <button class="refresh-btn" id="r-btn" onclick="refresh()">‚Üª</button>
    </div>

    <div class="filter-group">
        <div class="f-label">–ê–≥–µ–Ω—Ç—Å—Ç–≤–æ</div>
        <div class="scroll-row">
            <button class="d-btn active" onclick="setF('p','all',this)">–í—Å–µ</button>
            <button class="d-btn" onclick="setF('p','intercity',this)">Intercity</button>
            <button class="d-btn" onclick="setF('p','osypa',this)">City (Osypa)</button>
            <button class="d-btn" onclick="setF('p','shuttle',this)">Airport</button>
        </div>
    </div>

    <div class="filter-group">
        <div class="f-label">–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</div>
        <div class="scroll-row">
            <button id="day-auto" class="d-btn active" onclick="setF('d','auto',this)">–ê–≤—Ç–æ</button>
            <button id="day-weekday" class="d-btn" onclick="setF('d','weekday',this)">–ë—É–¥–Ω–∏</button>
            <button id="day-weekend" class="d-btn" onclick="setF('d','weekend',this)">–í—ã—Ö–æ–¥–Ω—ã–µ</button>
        </div>
    </div>

    <div id="app"></div>

    <div id="modal" class="modal" onclick="closeM(event)">
        <div class="m-content" onclick="event.stopPropagation()">
            <div id="m-t" style="font-size:2rem; font-weight:800; color:var(--p); margin-bottom:10px;"></div>
            <div id="m-n" style="font-size:1rem; color:#444; margin-bottom:20px; line-height:1.5; background:#f8f9fa; padding:10px; border-radius:8px;"></div>
            <button onclick="closeM()" style="background:var(--p); color:#fff; border:none; padding:10px 25px; border-radius:20px; font-size:1rem; width:100%;">OK</button>
        </div>
    </div>

    <script>
        let DATA = [];
        let STATE = { 
            p: 'all', // –ü—Ä–æ–≤–∞–π–¥–µ—Ä
            d: 'auto' // –¢–∏–ø –¥–Ω—è (auto, weekday, weekend)
        };

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –¥–Ω—è
        function getCurrentDayType() {
            const day = new Date().getDay();
            // 0 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 6 = –°—É–±–±–æ—Ç–∞
            return (day === 0 || day === 6) ? 'weekend' : 'weekday';
        }

        async function load() {
            document.getElementById('app').innerHTML = '<div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>';
            try {
                const res = await fetch('/api/data');
                DATA = await res.json();
                render();
            } catch(e) { document.getElementById('app').innerHTML = '<div class="loader">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
        }

        function render() {
            const c = document.getElementById('app');
            c.innerHTML = '';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Ç–∏–ø –¥–Ω—è —Å–µ–π—á–∞—Å –∞–∫—Ç–∏–≤–µ–Ω
            const activeDayType = STATE.d === 'auto' ? getCurrentDayType() : STATE.d;

            // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
            const fData = DATA.filter(route => {
                // 1. –§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
                const matchProv = (STATE.p === 'all' || route.prov === STATE.p);
                
                // 2. –§–∏–ª—å—Ç—Ä –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏
                // –ú–∞—Ä—à—Ä—É—Ç—ã —Å —Ç–∏–ø–æ–º 'all' –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞. 
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–Ω–µ–º.
                const matchDay = (route.type === 'all' || route.type === activeDayType);

                return matchProv && matchDay;
            });

            if(!fData.length) { c.innerHTML = '<div class="loader">–†–µ–π—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }

            fData.forEach(r => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ –¥–Ω—è –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ–∂–≥–æ—Ä–æ–¥–∞)
                const dayBadge = r.type !== 'all' ? `<span class="day-badge">${r.type === 'weekday' ? '–ë—É–¥–Ω–∏' : '–°–±/–í—Å'}</span>` : '';

                const timesHtml = r.times.map(t => {
                    if (t.t === 'LINK') {
                        return `<a href="${t.url || r.url}" target="_blank" class="t-btn" style="grid-column: 1/-1; text-decoration:none; background:var(--p); color:#fff;">${t.f}</a>`;
                    }
                    const noteTxt = t.note_txt ? t.note_txt.replace(/"/g, '&quot;') : ''; 
                    const action = noteTxt ? `onclick="showN('${t.t}', '${t.n}', '${noteTxt}')"` : '';
                    return `<div class="t-btn ${noteTxt ? 'has-note' : ''}" ${action}>${t.t}<sup>${t.n||''}</sup></div>`;
                }).join('');

                card.innerHTML = `
                    <div class="c-head">
                        <div>
                            <span class="c-title">${r.name}</span>${dayBadge}
                            <div class="c-desc">${r.desc}</div>
                        </div>
                        <a href="${r.url}" target="_blank" style="color:var(--p);text-decoration:none;font-size:1.2rem">‚Üó</a>
                    </div>
                    <div class="times-grid">${timesHtml}</div>
                `;
                c.appendChild(card);
            });

            highlightNext();
        }

        function setF(k, v, el) { 
            STATE[k] = v;
            el.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            render(); 
        }

        function highlightNext() {
            const now = new Date();
            const curMins = now.getHours() * 60 + now.getMinutes();

            document.querySelectorAll('.card').forEach(card => {
                let foundNext = false;
                card.querySelectorAll('.t-btn').forEach(btn => {
                    const txt = btn.innerText.replace(/[^\d:]/g, ''); 
                    if (!txt || txt.length < 4) return;
                    const [h, m] = txt.split(':').map(Number);
                    let busMins = h * 60 + m;
                    
                    let effectiveBus = busMins;
                    let effectiveCur = curMins;
                    if (effectiveBus < 180) effectiveBus += 1440; 
                    if (effectiveCur < 180) effectiveCur += 1440;

                    btn.classList.remove('past', 'next');
                    if (effectiveBus < effectiveCur) {
                        btn.classList.add('past');
                    } else if (!foundNext) {
                        btn.classList.add('next');
                        foundNext = true;
                    }
                });
            });
        }

        function showN(t, s, n) { 
            document.getElementById('m-t').innerText = t + s; 
            document.getElementById('m-n').innerText = n; 
            document.getElementById('modal').style.display = 'flex'; 
        }
        function closeM() { document.getElementById('modal').style.display = 'none'; }

        async function refresh() {
            const btn = document.getElementById('r-btn'); btn.classList.add('spinning');
            await fetch('/api/refresh', {method:'POST'});
            const iv = setInterval(async () => {
                const s = await (await fetch('/api/status')).json();
                if(!s.updating) { clearInterval(iv); btn.classList.remove('spinning'); load(); }
            }, 2000);
        }
        
        load();
        setInterval(highlightNext, 60000);
    </script>
</body>
</html>